#!/bin/bash
#
# SUBMIT launch script.
#

# Determining system batch

TEST_SLUR=`echo $(which sbatch)`     # Slurm System
TEST_PBSS=`echo $(which qsub)`       # Torque/PBS (Portable Batch System)
TEST_LSFS=`echo $(which bsub)`       # LSF (Load Sharing Facility)
TEST_HTCO=`echo $(which bsubmit)`    # HTCondor System
TEST_LLSB=`echo $(which llsubmit)`   # IBM Batch System
TEST_SGES=`echo $(which sge_submit)` # Grid Engine (SGE)

if [[ `echo $TEST_SLUR` != "" ]]; then
   MACHINE="SLUR"  # Slurm System                        (sbatch)
elif [[ `echo $TEST_PBSS`   != "" ]]; then
   MACHINE="PBSS"  # Torque/PBS (Portable Batch System)  (qbub)
elif [[ `echo $TEST_LSFS` != "" ]]; then
   MACHINE="LSFS"  # LSF (Load Sharing Facility)         (bsub)
elif [[ `echo $TEST_HTCO` != "" ]]; then
   MACHINE="HTCO"  # HTCondor System                     (bsubmit)
elif [[ `echo $TEST_LLSB` != "" ]]; then
   MACHINE="LLSB"  # IBM Batch System                    (llsubmit)
elif [[ `echo $TEST_SGES` != "" ]]; then
   MACHINE="SGES"  # Grid Engine (SGE)                   (sge_submit)
else
   MACHINE="LOCAL" # Local machine
# else
#    echo
#    echo " --------------------------------------"
#    echo " The execution machine is not defined."
#    echo " Please adjust the submission script."
#    echo " --------------------------------------"
#    echo
#    exit
fi

# Showing the program help

if [[ `echo $1 | grep -i "ver"` != "" ]]; then

   clear
   echo
   echo -e "\033[1;34m ========================================== \033[0m"
   echo -e "\033[1;33m Script Developed by:                       \033[0m"
   echo
   echo -e "\033[1;20m Daniel G. Silva                            \033[0m"
   echo -e "\033[1;30m e-mail: gabriel82silva.dg@gmail.com        \033[0m"
   echo -e "\033[1;30m         daniel.gabriel@academico.ufpb.br   \033[0m"
   echo -e "\033[1;34m ========================================== \033[0m"
   echo -e "\033[1;31m                    Last update: 09.03.2022 \033[0m"
   echo
   exit

elif [[ -z $1 ]]; then

   FILES=`ls *.com *.gjf *.inp *.xyz *.gro`

   clear
   echo
   echo -e "\033[1;34m --------------------------------------------------- \033[0m"
   echo -e "\033[1;31m submit <program> <input.ext> <-options> <-ntasks I> \033[0m"
   echo
   echo -e "\033[1;33m PARAMETERS                                          \033[0m"
   echo -e "\033[1;21m      program     [gsn/orca/xtb/gmx program]         \033[0m"
   echo -e "\033[1;21m      input.ext   [Input GJF/COM/INP/XYZ/GRO file]   \033[0m"
   echo
   echo -e "\033[1;33m OPTIONS/DEFAULTS                                    \033[0m"
   echo -e "\033[1;21m     -options     [Program specific options]         \033[0m"
   echo -e "\033[1;21m     -queue  T    [Name of available queue]          \033[0m"
   echo -e "\033[1;21m     -nodes  I    [Number of requested nodes ]       \033[0m"
   echo -e "\033[1;21m     -ntasks I    [Number of processors]             \033[0m"
   echo -e "\033[1;21m     -preserv     [Preserv the submission job file]  \033[0m"
#    echo
#    echo -e "\033[1;33m ADDITIONAL                                          \033[0m"
#    echo -e "\033[1;21m     -batch  T    [Name of system batch]             \033[0m"
   echo
   echo -e "\033[1;33m AVAILABLE SYSTEM BATCH                              \033[0m"
   if [[ $MACHINE == "PBSS" ]]; then
      echo "     »Torque/PBS (Portable Batch System) [qbub]"
   elif [[ $MACHINE == "LSFS" ]]; then
      echo "     »LSF (Load Sharing Facility) [bsub]"
   elif [[ $MACHINE == "SLUR" ]]; then
      echo "     »Slurm System [sbatch]"
   elif [[ $MACHINE == "HTCO" ]]; then
      echo "     »HTCondor System [bsubmit]"
   elif [[ $MACHINE == "LLSB" ]]; then
      echo "     »IBM Batch System [llsubmit]"
   elif [[ $MACHINE == "SGES" ]]; then
      echo "     »Grid Engine (SGE) [sge_submit]"
   elif [[ $MACHINE == "LOCAL" ]]; then
      echo "     »Local Machine"
   else
      echo "     »NOT DEFINED"
   fi
   echo -e "\033[1;34m --------------------------------------------------- \033[0m"
   echo

   infos -compact

   if [[ $FILES != "" ]]; then
      echo
      echo " Input(s):"
      echo
      echo " » "$FILES
      echo
   else
      echo
   fi

   exit

fi

# Determining system configuration

NUMMACS=1 # <<< For a job running on a cluster, modify this !!

if [[ `lscpu      | grep -ia "Thread(s) per núcleo:"  | grep -ia -v list | grep -ia -v numa | head -n1 | awk '{print $4}'` != "" ]]; then
   MAXCPUS=`lscpu | grep -ia "CPU(s):"                | grep -ia -v list | grep -ia -v numa | head -n1 | awk '{print $2}'`
   MAXPROC=$((NUMMACS*MAXCPUS))
else
   MAXCPUS=`lscpu | grep -ia "CPU(s):"                | grep -ia -v list | grep -ia -v numa | head -n1 | awk '{print $2}'`
   MAXPROC=$((NUMMACS*MAXCPUS))
fi

# Verify if program and input files exist

if [[ `echo $(which $1)` = "" ]]; then
   echo
   echo " -------------------------------"
   echo " Input: "$1
   echo " -------------------------------"
   echo " The program file was not found!"
   echo " -------------------------------"
   echo
   exit
elif [[ ! -f $2 ]]; then
   echo
   echo " -----------------------------"
   echo " Input: "$1
   echo " -----------------------------"
   echo " The input file was not found!"
   echo " -----------------------------"
   echo
   exit
fi

# Setting environment variables

PROGEXE=$1
JOBNAME=`echo $2 | sed s/\.com/\/ | sed s/\.inp/\/ | sed s/\.xyz/\/ | sed s/\.gro/\/ | sed s/\.pdb/\/ | sed s/\.ent/\/ | sed s/\.log/\/ | sed s/\.out/\/ | sed s/\.xtb/\/ | sed s/\.trj/\/ | sed s/\.trx/\/ | sed s/\.try/\/ | sed s/\.trz/\/ | sed s/\.slt/\/ | sed s/\.tng/\/ | sed s/\.trr/\/ | sed s/\.xtc/\/`
INPNAME=$2
WORKDIR=$JOBNAME"_running"
WORKCFG=`echo $@ | sed s/\$1/\/ | sed s/\$2/\/ | sed s/\-preserv/\/`

# Setting execution parameters

TPQUEUE="" # Default values
CNNODES=""
CNTASKS="2"
CFGSAVE="NO"
while [ "$1" != "" ]; do
   case $1 in
      -queue)
         if [ -n "$2" ]; then
            TPQUEUE="$2"
            shift 2
            continue
         else
            echo ' ERROR: the option "-queue" requires a non-empty argument.'
            exit
         fi;;
      -nodes)
         if [ -n "$2" ]; then
            CNNODES="$2"
            shift 2
            continue
         else
            echo ' ERROR: the option "-nodes" requires a non-empty argument.'
            exit
         fi;;
      -ntasks|-proc|-procs|-nproc|-nprocs)
         if [ -n "$2" ]; then
            CNTASKS="$2"
            shift 2
            continue
         else
            echo ' ERROR: the option "-ntasks" requires a non-empty argument.'
            exit
         fi;;
      -preserv)
         CFGSAVE="YES";;
   esac
   shift
done
if [[ $CNTASKS != "" && $(echo "$CNTASKS > $MAXPROC" | bc) -eq 1 ]]; then
   CNTASKS=$MAXPROC
fi

# Showing execution information

if [[ $MACHINE != "LOCAL" ]]; then

   echo
   echo " Creating and executing the job..."
   echo " ========================================================="
   echo "  JOB Name:" $JOBNAME
   echo "   Program:" $PROGEXE
   echo "     Input:" $INPNAME
   echo "   Options:" $WORKCFG
   echo "    Procs.:" $CNTASKS "(Max.:" $MAXPROC")"
   echo " ========================================================="
   echo

fi

# Creating and executing the job

if [[ $MACHINE = "SLUR" ]]; then   # Slurm System

   echo '#!/bin/bash                                                '  > $JOBNAME.job
   echo '                                                           ' >> $JOBNAME.job
   echo '#SBATCH --job-name='$JOBNAME'                              ' >> $JOBNAME.job
  #echo '#SBATCH --ntasks='$CNTASKS'                                ' >> $JOBNAME.job
   echo '#SBATCH --ntasks-per-node='$CNTASKS'                       ' >> $JOBNAME.job
   echo '#SBATCH --time=300:00:00                                   ' >> $JOBNAME.job
   echo '                                                           ' >> $JOBNAME.job
   echo 'echo "## Job started at"' $(date +'%d-%m-%Y as %T') '      ' >> $JOBNAME.job
   echo 'echo "## Job execution node:  $(hostname -s)"              ' >> $JOBNAME.job
   echo 'echo "## Job number of tasks: $SLURM_NTASKS"               ' >> $JOBNAME.job
   echo 'echo "## Submission folder:   $SLURM_SUBMIT_DIR"           ' >> $JOBNAME.job
   echo 'echo "## Executing folder:    $SLURM_SUBMIT_DIR/'$WORKDIR'"' >> $JOBNAME.job
   echo '                                                           ' >> $JOBNAME.job
   echo $PROGEXE $INPNAME $WORKCFG' -local &                        ' >> $JOBNAME.job
   echo '                                                           ' >> $JOBNAME.job

   sed -i "s/ntasks=[0-9][0-9][0-9]//g" $JOBNAME.job
   sed -i "s/ntasks=[0-9][0-9]//g" $JOBNAME.job
   sed -i "s/ntasks=[0-9]//g" $JOBNAME.job

   sbatch $JOBNAME.job; if [ $CFGSAVE = "NO" ]; then rm -f $JOBNAME.job ; fi

   echo

elif [[ $MACHINE = "PBSS" ]]; then # Torque/PBS (Portable Batch System)

   if [[ $TPQUEUE == "serial" ]]; then
      DIRECTIVE="NO"
   elif [[ $TPQUEUE == "testes" ]]; then
      DIRECTIVE="YES"
   elif [[ $TPQUEUE == "testegpu" ]]; then
      DIRECTIVE="NO"
   elif [[ $TPQUEUE == "par128" ]]; then
      DIRECTIVE="YES"
      NTASKS=128
   elif [[ $TPQUEUE == "par16" ]]; then
      DIRECTIVE="YES"
      NTASKS=16
   elif [[ $TPQUEUE == "paralela" ]]; then
      DIRECTIVE="YES"
      NTASKS=128
   elif [[ $TPQUEUE == "expressa" ]]; then
      DIRECTIVE="YES"
      NTASKS=128
   elif [[ $TPQUEUE == "memshort" ]]; then
      DIRECTIVE="YES"
      NTASKS=128
   elif [[ $TPQUEUE == "memlong" ]]; then
      DIRECTIVE="YES"
      NTASKS=128
   elif [[ $TPQUEUE == "umagpu" ]]; then
      DIRECTIVE="NO"
   elif [[ $TPQUEUE == "duasgpus" ]]; then
      DIRECTIVE="NO"
   fi

   echo "#!/usr/bin/bash                            "   > $JOBNAME.job
   echo "#PBS -N $JOBNAME                           "  >> $JOBNAME.job
   echo "#PBS -q $TPQUEUE                           "  >> $JOBNAME.job
   if [[ $DIRECTIVE == "YES" ]]; then
   echo "#PBS -l nodes=$CNNODES:ppn=$NTASKS         "  >> $JOBNAME.job
   fi
   echo "#PBS -e erro_$JOBNAME.qsub                 "  >> $JOBNAME.job
   echo "#PBS -o relt_$JOBNAME.qsub                 "  >> $JOBNAME.job
   echo '                                           '  >> $JOBNAME.job
   echo 'qstat -u $USER | grep -v ada: | sed '/^$/d''  >> $JOBNAME.job
   echo '                                           '  >> $JOBNAME.job
   echo 'cd "$PBS_O_WORKDIR"                        '  >> $JOBNAME.job
   echo '                                           '  >> $JOBNAME.job
   echo "time $PROGEXE $INPNAME $WORKCFG -local &   "  >> $JOBNAME.job

   qsub $JOBNAME.job; if [ $CFGSAVE = "NO" ]; then rm -f $JOBNAME.job ; fi

   echo

else # Local machine

   $PROGEXE $INPNAME $WORKCFG -local &

fi
